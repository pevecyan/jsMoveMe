<html>
	<head>
		
	</head>
	<body>
		<body style="background-color: white; margin:0px;">

		  <canvas id="gameCanvas" width="400" height="200">-</canvas>
		  <script>
		    var canvas = document.getElementById('gameCanvas');
		    var context = canvas.getContext('2d');
		
		    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
			
			/*touch input*/
			canvas.addEventListener('touchmove', function(event) {
			  // If there's exactly one finger inside this element
			  if (event.targetTouches.length == 1) {
			    var touch = event.targetTouches[0];
			    // Place element where the finger is
			    if(!(touch.pageY == 0 && touch.pageX == 0) && gameState == 1)
			    {
			    	mouseX = touch.pageX;
			    	mouseY = touch.pageY;
			    }
			    document.getElementById("info1").innerText = mouseX+":"+mouseY;
			  }
			}, false);
			
			canvas.addEventListener('touchend', function(event){
			    if (gameState == 0) { gameState = 1;}
			}, false);
			

            //Player
			var mouseX = 190, mouseY = 90;
			var trailRects = new Array();
			var speed = 3;



			/*GameStates: 0 - menu, 1 - loading 2 -game*/
			var gameState = 0;
			
            /*Menu variables*/
			var textX = -100, textY = 50;
			var textOffsetY = 0, textOffsetX;
			
			/*Tracking time*/
			var start = null;
			var currentTime = 0, previousTime = 0;
			
			/*Timer for events*/
			var elapsedTextTime = 0;
			
			var movingObstaclesTime = 0;
			var moving = false;
			
			/*Obstacles*/
			var obstacles = new Array();
			
			
			/*Background*/
			var back = new Array();
			var middle = new Array();
			var front = new Array();
			
			var middleGeneration = new BgGenerationSettings(0, 14, 18, 14);
			var backGeneratation = new BgGenerationSettings(0,10,14,10);

            /**/
			function BgGenerationSettings(difference, height, upLimit, downLimit){
			    this.difference = difference;
			    this.height = height;
			    this.upLimit = upLimit;
			    this.downLimit = downLimit;
			}
			
			
			function Background(x, y, width, height){
				this.x = x;
				this.y = y;
				this.width = width;
				this.height = height;
			}
			
			function createMiddleBackground(){
			    
			    if (middle.length == 0) middle[middle.length] = new Background(0, 0, 20, middleGeneration.height + middleGeneration.difference);
			    else middle[middle.length] = new Background(middle[middle.length - 1].x + 20, 0, 20, middleGeneration.height+middleGeneration.difference);

			    middleGeneration.difference = Math.floor((Math.random() * 3) - 1)
			    if (middleGeneration.height + middleGeneration.difference > middleGeneration.downLimit || middleGeneration.height + middleGeneration.difference < middleGeneration.upLimit) { middleGeneration.difference = -middleGeneration.difference; }
			    
			}

			function createBackBackground() {

			    if (back.length == 0) back[back.length] = new Background(0, 0, 20, backGeneratation.height + backGeneratation.difference);
			    else back[back.length] = new Background(back[back.length - 1].x + 20, 0, 20, backGeneratation.height + backGeneratation.difference);

			    backGeneratation.difference = Math.floor((Math.random() * 3) - 1)
			    if (backGeneratation.height + backGeneratation.difference > backGeneratation.downLimit || backGeneratation.height + backGeneratation.difference < backGeneratation.upLimit) { backGeneratation.difference = -backGeneratation.difference; }

			}

			function update(gameTime){
			  	if(start == null){start = gameTime;}
			  	currentTime = gameTime-start;
			  	
			  	if(gameState == 0){
			  		
			  		elapsedTextTime += currentTime - previousTime;
			  		if (elapsedTextTime >= 10) {
			  		    elapsedTextTime = 0;
			  		    //textOffsetX = Math.floor(Math.random() * 4) - 2;
			  		    //textOffsetY = Math.floor(Math.random() * 4) - 2;
			  		}
                    
			  		textOffsetX = Math.sin(gameTime / 200) * 10 ;
			  		

			  		mouseY = Math.sin(gameTime/200)*20+90;
			  		
			  		
			  		
			  		
			  		
			  	}
			  	else if(gameState == 1){
			  		if(obstacles.length < 10){
			  			if(!moving)createObstacle(true);
			  			else createObstacle();
			  			
			  			
			  		}else if(mouseX > 0 || mouseY>0){
			  			moving = true;
			  		}

			  		
			  		//document.getElementById("info1").innerText = ":"+obstacles.length;
				  	
				  	
				  	movingObstaclesTime += (currentTime-previousTime);
				  	
				  	
				  	/*Moving obstacles*/
				  	if (moving) {
				  	   
				  		for(var i = 0; i < obstacles.length; i++){
							obstacles[i].x -= speed;
							if(obstacles[i].x <= 0-obstacles[i].width){obstacles.shift(); i--;}
				  		}
				  		

						
				  	}
				  	
				  	
				  	/*Collision with player*/
				  	for(var i = 0; i < obstacles.length; i++){
				  		if(collides(obstacles[i],new Obstacle(20,20,mouseX-10, mouseY-1))){
				  			document.getElementById("info2").innerText = "GameOver";}
				  	}
			  	}

			  	trailRects[trailRects.length] = new Background(mouseX - 11, mouseY - 10 + 9, 4, 3);
			  	if (trailRects.length > 10) { trailRects.shift(); }
			  	for (var i = 0; i < trailRects.length; i++) {

			  	    trailRects[i].x -= speed;

			  	}

			    /*Moving background*/
			  	if (middle.length < 25) {
			  	    createMiddleBackground();
			  	}
			  	if (back.length < 25) {
			  	    createBackBackground();
			  	}
			  	for (var i = 0; i < middle.length; i++) {
			  	    middle[i].x -= 2
			  	    if (middle[i].x <= -middle[i].width) { middle.shift(); i--; }
			  	}
			  	for (var i = 0; i < back.length; i++) {
			  	    back[i].x -= 1
			  	    if (back[i].x <= -back[i].width) { back.shift(); i--; }
			  	}
                


				draw();
			  	document.getElementById("info").innerText = "fps:"+Math.round(1000/(currentTime-previousTime));
			  	previousTime = currentTime;
			  	requestAnimationFrame(update);
			}
			
			function draw(){
				context.clearRect(0, 0, 400, 200);

				context.fillStyle = "#A0A0A0";
				context.fillRect(0, 0, 400, 200);
				for (var i = 0; i < middle.length; i++) {
				    context.fillStyle = "#404040";
				    context.fillRect(middle[i].x, middle[i].y, 20, middle[i].height * 10);
				    //alert(middle[i].height);
				}
				for (var i = 0; i < back.length; i++) {
				    context.fillStyle = "#000000";
				    context.fillRect(back[i].x, back[i].y, 20, back[i].height * 10);
				    //alert(back[i].x+"x:"+middle[i].height+"h:"+back[i].y+"y:w"+back[i].width);
				}
				drawMoon();

				if(gameState == 0){
				    

				    context.fillStyle = "#A0A0A0";
				    context.font = "16pt Arial";
				    
				    context.fillText("TAP ANYWHERE TO START", 200 - context.measureText("TAP ANYWHERE TO START").width/2 +textOffsetX - 50, textY+textOffsetY);

			  	}
				else if(gameState==1){
					
					
					
					context.fillStyle = "#00A";
					for(var i = 0; i < obstacles.length; i++){
						
						context.fillRect(obstacles[i].x,obstacles[i].y,obstacles[i].width,obstacles[i].height);
						
					}
					
					
					
				}
				drawPlayer(mouseX, mouseY);
                
				context.fillStyle = "#7F0000";
				for (var i = 0; i < trailRects.length; i++) {
				    context.fillRect(trailRects[i].x, trailRects[i].y, trailRects[i].width, trailRects[i].height);
				}
				
    			
			}
			

			function drawPlayer(x, y) {
                //HEAD
			    context.fillStyle = "#FFE97F";
			    context.fillRect(x - 10, y - 10, 20, 20);
			    //glasses
			    context.fillStyle = "#7F0000";
			    context.fillRect(x - 10, y - 10 + 8, 20, 3);
			    context.fillRect(x - 10 + 3, y - 10 + 7, 17, 1);
			    context.fillRect(x - 10 + 8, y - 10 + 6, 12, 1);
			    context.fillStyle = "#00FFFF";
			    context.fillRect(x - 10 + 16, y - 10 + 7, 4, 3);
			    context.fillStyle = "#000000";
			    context.fillRect(x - 10 + 17, y - 10 + 16, 3, 2);

                
			}

			function drawMoon() {
			    context.fillStyle = "#373737";
			    context.fillRect(300, 0+5, 50, 50);
			    context.fillStyle = "#FFFFFF";
			    context.fillRect(300+10, 10+5,30, 30);
			}
			/*return obstacle <height>height of obsatacle</height>, <location>located on top(0), located on bottom(1)</location>*/
			function Obstacle(height, width, x,y){
				this.height = height;
				this.width = width;
				this.y = y;
				this.x = x;				
			}
			
			function createObstacle(firstTime){
				
				var height = Math.floor((Math.random()*7)+4);
	  			var y = 0;
	  			if(Math.floor((Math.random()*2))==0){y = 0;}
	  			else{y = 200-height*10;}
	  			
	  			if(firstTime)obstacles[obstacles.length] = new Obstacle(height*10,20,obstacles.length*80 +400,y);
				else obstacles[obstacles.length] = new Obstacle(height*10,20,obstacles[obstacles.length-1].x+60,y);
				
				//if(firstTime == 1)obstacles[obstacles.length] = new Obstacle(50,50,100,100);
			}	
			
			function collides(a, b)
			{
			  	return a.x < b.x + b.width &&
				       a.x + a.width > b.x &&
				       a.y < b.y + b.height &&
				       a.y + a.height > b.y;
			}
			
			requestAnimationFrame(update);
		  </script>
		  	<p id="info">-</p><br />
			<p id="info1">-</p><br />
			<p id="info2">-</p><br />
</body>
	
</html>